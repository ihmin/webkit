<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html>
<head>
<script src="../resources/accessibility-helper.js"></script>
<script src="../resources/js-test.js"></script>
</head>
<body>

<div id="test-container">
    <div id="wrapper" role="dialog" aria-modal="true">
      Some text
      <p>A paragraph<span>Foo</span></p>
      More text
    </div>
</div>
<div id="modal-container"></div>
<div id="div" role="group" aria-label="foo"></div>

<script>
var output = "This test ensures we don't crash trying to update the modal node when a text node has recently been destroyed, and relations are dirty.\n\n";

const modalHTML = `
<div role="dialog" aria-modal="true">
    Foo
    <button id="press">Press!</button>
    <div role="group" aria-owns="press" aria-label="foo">
    </div>
</div>
`;

if (window.accessibilityController) {
    // Make sure the accessibility tree has been fully generated by walking over it.
    output += dumpAXSearchTraversal(accessibilityController.rootElement.childAtIndex(0));

    const textNodes = [];
    const walker = document.createTreeWalker(document.getElementById("wrapper"), NodeFilter.SHOW_ALL, null, false);
    while (walker.nextNode()) {
        const node = walker.currentNode;
        if (node.nodeType === Node.TEXT_NODE && node.textContent.trim())
            textNodes.push(node);
    }

    const generateRandomString = () => {
        return Math.random().toString(36).substring(2, 6);
    };
    let shouldRemoveModal = false;
    const div = document.getElementById("div");
    const modalContainer = document.getElementById("modal-container");
    while (textNodes.length) {
        textNodes.pop().remove();

        // Force the relations cache to become dirty.
        div.id = generateRandomString();
        div.setAttribute("aria-owns", generateRandomString());

        // Toggle the existence of a modal, forcing us to re-compute it.
        if (shouldRemoveModal)
            modalContainer.replaceChildren();
        else
            modalContainer.innerHTML = modalHTML;

        shouldRemoveModal = !shouldRemoveModal;
    }

    output += "PASS: No crash\n";
    debug(output);
}
</script>
</body>
</html>

